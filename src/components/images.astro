---
import { Image } from '@astrojs/image/components'
import exifr from 'exifr'
import 'photoswipe/style.css'
import 'photoswipe-dynamic-caption-plugin/photoswipe-dynamic-caption-plugin.css'

export interface Props {
  images: string[]
}

const { images } = Astro.props

const imageFiles = import.meta.glob<ImageMetadata>('../images/**/*.{png,webp,jpg,jpeg}', { import: 'default', eager: true })
const folderFiles = Object.keys(imageFiles).filter(image => images.includes(image))
const imageSrc = images.map(image => imageFiles[image])
const imagetitles = folderFiles.map(image => image.slice(0, image.lastIndexOf('.')).slice(image.lastIndexOf('/') + 1))
// console.log(images)
const exifs = [] as Record<string, any>[]
for (let i in folderFiles) {
  const exif = await exifr.parse(folderFiles[i].replace('../', './src/'))
  exifs.push(exif)
}
// console.log(exifs)

---
<style>
  .pswp--custom-icon-colors {
    --pswp-icon-color: #eee;
    --pswp-icon-color-secondary: #663399;
  }

  .pswp__dynamic-caption--aside {
    max-width: 300px;
    padding: 20px 15px 20px 20px;
    margin-top: 70px;
  }

  .pswp__dynamic-caption--below {
    max-width: 700px;
    padding: 15px 0 0;
  }

  .pswp__dynamic-caption--mobile {
    background: rgba(0, 0, 0, 0.5);
    padding: 10px 15px;
  }
</style>
<p class="text-sm text-gray-500 italic">Please click on any photo to view in a lightbox. Use arrow keys or swipe to navigate.</p>
<div id="gallery" class="w-full block not-prose" itemscope itemtype="http://schema.org/ImageGallery">
  {imageSrc.map((image, i) => (
    <figure itemscope itemtype="http://schema.org/ImageObject" class="inline-block text-gray-800 dark:text-gray-300 bg-gray-300 dark:bg-gray-800 text-sm text-center italic rounded">
    <a href={image.src} itemprop="contentUrl" data-pswp-width={image.width} data-pswp-height={image.height}>
      <Image src={image} alt={imagetitles[i]} format="webp" class="rounded" />
      <span class="pswp-caption-content">
        {imagetitles[i]}
        {exifs[i] && exifs[i].Make && <span>{' (' + exifs[i].Make + ' ' + exifs[i].Model  + ')'}</span>}
      </span>
    </a>
    <figcaption itemprop="caption description" class="rounded">
      {imagetitles[i]}
    </figcaption>
    </figure>

  ))}
</div>
<script>
  import PhotoSwipeLightbox from 'photoswipe/lightbox'
  import PhotoSwipeDynamicCaption from 'photoswipe-dynamic-caption-plugin'
  
  const lightbox = new PhotoSwipeLightbox({
    mainClass: 'pswp--custom-icon-colors',
    gallerySelector: '#gallery',
    childSelector: 'a',
    pswpModule: () => import('photoswipe'),
    paddingFn: (viewportSize) => {
      return {
        top: 0, bottom: 30, left: 0, right: 0
      }
    }
  })
  
  const captionPlugin = new PhotoSwipeDynamicCaption(lightbox, {
    captionContent: '.pswp-caption-content',
    type: 'below',
  });
  
  lightbox.init()
  </script>
